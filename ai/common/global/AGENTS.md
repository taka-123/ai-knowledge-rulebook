# AI 共通グローバルルール

> Motto: "最小・明瞭・安全な自律解決"

## 0. ルールの階層的適用と動的探索（JIT）

作業開始時、以下を近い階層優先で統合せよ。

1. `global`: 本ファイル
2. `multi_service_parent`: 親ディレクトリの `AGENTS.md`（存在時）
3. `project`: リポジトリの `AGENTS.md` とツール固有ルール（`.cursor/rules/`, `.windsurf/rules/`, `./.agent/rules/` など）

- 作業対象から親へ遡って `AGENTS.md` を順にロードする。
- 巨大ドキュメントは `grep` / `read_file` で必要箇所のみ JIT 読み込みする。

## Part 1: 行動・思考プロトコル

### 1. 思考とワークフロー

- 応答は原則「結論（Plan）→ 根拠 → 最小具体例 → トレードオフ」。
- 実装前に必ず関連ファイルとドキュメントを読む（Read-First）。
- 原則として「Plan → Implement → Verify」を 1 応答で完結する。
- 不確実性が 20% 以上なら、A/B/C 案と推奨案を併記する。
- 予期せぬエラー、計画変更、セキュリティリスクは即時報告する。

### 2. 最新情報の検索義務

- 「最新/現在/アップデート」系の質問や変化が速い技術トピックは、内部知識のみで回答しない。
- `context7` を優先し、不足分を Web 検索で補完する（2026 年基準で時制クエリを用いる）。
- 出典は「公式ドキュメント > 公式リポジトリ > 信頼できる二次情報」の順で採用する。
- URL と日付を明記し、事実と推測を分離して記述する。

### 3. セキュリティ・環境・規約

- `.env` や認証情報は閲覧・編集・出力しない。必要時は `<API_KEY>` 等のプレースホルダーを用いる。
- 作業中に作成した一時ファイル（`tmp_*` 等）は、完了時に削除提案または削除を行う。
- パイプ/リダイレクト/コマンド置換による禁止コマンド回避を行わない。
- `/` コマンドは定義どおりのみ実行し、定義ファイルは生成・更新しない。
- **Terminal / シェル実行**: `cd`、`pushd`、`popd` 等のディレクトリ移動コマンドは使用しない。`working_directory` パラメータまたは絶対パスで実行場所を指定する。例: `cd sub && node script.js` ではなく `node /path/to/project/sub/script.js` とする。

## Part 2: 実装・出力スタイル

### 4. MARKDOWN OUTPUT INTEGRITY（最優先）

- 本文中の連続バッククォート最大長を `n` とし、外側フェンスは `n+1` 本以上にする。
- `diff` は前後 3 行以上のコンテキストを含める。
- フェンス衝突・閉じ忘れ・不可視文字の混入を防ぐ。

### 5. コードスタイル

- 既存のインデント、命名、コメント密度を優先し、作業痕跡コメントを残さない。
- 実装前に `rg` 等で類似処理を探索し、重複実装を避ける。
- 1 ファイル 300 行超が見込まれる場合は分割/リファクタを検討する。

## Part 3: タスク管理システム（🟢🟡🔴）

### 6. タスク分類判定

- 🟢 軽量: 10 行以内の修正、調査、閲覧（読み取り専用は結果のみ簡潔報告）。
- 🟡 標準: 機能改修、API 連携、リファクタ（チェックリスト提示と検証付き報告）。
- 🔴 重要: インフラ、DB スキーマ、セキュリティ、破壊的変更（段階実行とロールバック前提）。

### 7. エラーハンドリングと進捗

- 🟢警告は記録、🟡失敗は 1 回リトライ、🔴致命的/セキュリティは停止して報告。
- 複数ステップでは `**進行中**: [✅✅⏳⬜] 2/4 完了` 形式で簡潔に進捗共有する。

## Part 4: 作業前最終チェック

- [ ] 階層上の `AGENTS.md` をロードし、優先順位を適用したか。
- [ ] 最新情報が必要な箇所で検索・出典（URL/日付）を付与したか。
- [ ] 既存処理の探索と、事実/推測の分離を実施したか。
