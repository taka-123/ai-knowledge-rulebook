# プロジェクト固有ガイドライン

## 0. 前提

- @README.md

### 技術スタック

- @technologystack.md

### ディレクトリ概要

- @directorystructure.md

## 1. 基本動作原則

- **指示理解**: ユーザー指示を精読し、範囲・制約・依存関係を確認する。不明点は即質問。
- **タスク分析**: 下記テンプレで目的から品質基準までを整理し、共有する。

```markdown
## タスク分析

- 目的: [最終目標]
- 技術要件: [利用技術・制約]
- 実装手順: [主要ステップ]
- リスク: [想定課題]
- 品質基準: [満たすべき指標]

### 重複実装の防止

- 既存の類似機能: [確認結果]
- 同名・類似名の要素: [確認結果]
- 共通化可能な処理: [確認結果]
```

- **プロセス選択**: タスク規模と影響から 🟢 / 🟡 / 🔴 を判定し、該当プロセスと報告テンプレを宣言する。
- **計画と実装**: 変更は最小単位で進め、既存スタイルと安全性を優先。各ステップ完了後に簡潔に進捗を報告する。

### 確認原則（承認プロセス）

以下の場合に**必ず**確認・承認を取得する：

- **不明点がある場合**: タスクの意図や要件が不明確な場合は作業開始前に質問する
- **重要な判断が必要な場合**: アーキテクチャ選択、セキュリティ影響、破壊的変更など
- **予期せぬ問題が発生した場合**: エラー、想定外の動作、制約違反などが発生した際は即座に報告
- **計画変更が必要な場合**: 最初の計画が失敗・変更が必要な場合は新計画を提示して確認を取る
- **迂回が必要な場合**: 別アプローチへの切り替えは必ず事前に報告・承認を得る
- **🔴 重要タスクの実装前**: 詳細分析と計画提示後、実装開始前に承認を取得する

**明示的に指示されていない変更は行わない**：必要と思われる変更がある場合は、まず提案として報告し、承認を得てから実施する

確認時は `【確認待ち】` セクションを置き、求めるアクションを明示する。

## 2. 実務フロー

- **初期分析**: 既存コード整合性、入力データ形式、セキュリティ・性能リスクを把握
- **実装**: 既存の変換・エラーパターンを踏襲し、変更範囲を最小化
- **検証**: 単体・統合・形式変換テストを実施し、結果を共有
- **最終確認**: 要件、品質、ドキュメント、ロールバック手段を最終チェック

### 実装チェックリスト

```markdown
1. [Input] エントリーポイントと受信データ確認
2. [Parser] レスポンス／ペイロードの解析と構造化
3. [Transform] 文字コード・形式変換
4. [Persistence] データベース／ストレージ更新
5. [Error] エラーハンドリング・ログ・リトライ
```

## 3. 品質・リスク管理

### テスト適用範囲

- 🟢 軽量: 構文・基本動作チェック
- 🟡 標準: データ処理・連携機能・変換結果の確認
- 🔴 重要: 統合・負荷・エラー挙動・セキュリティ検証

### 運用チェックポイント

- 既存スタイル・依存関係を最優先
- 変更は小さく段階的に。ロールバック手段を維持
- `.env` 等の機密情報には触れず、必要時は利用者に依頼
- 追加依存は最小限。不要になった依存は削除を検討
- SQL はキーワード大文字・句単位改行で整形
- 実ファイルに作業用コメントは残さない

### 禁止事項（プロジェクト固有）

- 不適切な文字コード変換処理（例: エンコーディング不整合）
- データ形式破壊（例: レガシーフォーマットの誤変換）
- 業務データ損失を招くエラー処理の不備
- **明示的に指示されていない変更**（必要な場合は提案として報告し、承認を得る）
- **UI/UXデザインの無断変更**（レイアウト、色、フォント、間隔など）
- **技術スタックのバージョン無断変更**（変更が必要な場合は理由を明示して承認を得る）

## 4. 報告とコンテキスト管理

### 軽量タスク報告

```markdown
**完了**: [対象] [タスク名] - 結果: [1 行要約]
```

### 標準タスク報告

```markdown
## 実行結果（対象機能）

**処理構成**: [主要コンポーネント]
**データ変換**: [形式・文字コード状況]
**外部連携**: [接続先・更新状況]
**注意点**: [既知の制約]
```

### 重要タスク報告

```markdown
# 実行結果詳細

## 概要

[全体要約]

## 技術スタック影響

- Runtime / SDK: [影響]
- 主要ライブラリ: [影響]

## 実装詳細

1. Handler 層: [実装内容]
2. Parser 層: [実装内容]
3. Convert 層: [実装内容]
4. Database 層: [実装内容]

## 変換・レガシー対応（プロジェクト固有の処理）

- 文字コード変換処理（例: CP932/Shift_JIS等）: [確認結果]
- エンコーディング関連の対策: [確認結果]
- レガシーシステム固有のデータ形式対応: [確認結果]

## 今後の保守注意事項

- [変換処理上の注意]
- [外部システム変更時の影響]
```

## 5. 承認が必要な変更

以下の変更は必ず事前承認を取得する：

- ランタイム・主要ライブラリのバージョン変更
- 外部システムとの通信仕様・プロトコル変更
- データベース／ストレージのスキーマ変更
- インフラ設定（権限・リソース・ネットワーク）変更
- セキュリティ・認証方式の変更
- UI/UXデザインの変更（レイアウト、色、フォント、間隔など）
- 破壊的変更、本番環境への影響がある変更
- 明示的に指示されていない新機能の追加
- 個人情報/機微データの取り扱い方針の変更
- 1 回または月額で USD 10 以上の実行コストを伴う作業や構成変更

### コマンド実行の承認

以下のコマンド実行は事前確認を取得する：

- 危険なコマンド（`rm -rf /`、`dd`、`git push --force`等）
- 任意コード実行（例: `python -c ...`、外部から取得したスクリプト実行等）

**例外**: プロジェクト標準のテスト/ビルド/リンター等（例: `npm test`, `pytest` 等）は、指示があれば確認なしで実行してよい

## 6. 今後の利用に向けたメモ

- 変更履歴を明確にし、承認プロセスを整備する
- ランタイムや外部システムの仕様変更時は、必要な承認とドキュメント更新を行う

## コードレビュー

**目的**: このリポジトリの PR で `@codex review` を使う際の、最小かつ再利用可能なレビュー基準を定める。

### 出力要件

- **言語**: 日本語（です/ます）
- **構成**: 概要 → **優先度 (P0–P3)** → 根拠 → **具体的修正例**（可能なら最小差分）→ 影響/リスク
- **総合判定**: 「**可/不可**」を明記（Merge 可否の参考）
- 指摘は最初に見つけたもの 1 件だけで止めずに、**問題箇所はすべて洗い出し**、1 つ 1 つ適切に指摘すること
- 重要度が高い指摘から最大件数まで列挙し、**最小の修正案**を提示

### 優先度（P0–P3）

- **<sub><sub>![P0 Badge](https://img.shields.io/badge/P0-red?style=flat)</sub></sub>**: ブロッカー（誤動作/セキュリティ/破壊的影響）＝ **マージ不可**
- **<sub><sub>![P1 Badge](https://img.shields.io/badge/P1-orange?style=flat)</sub></sub>**: 早急対応（次サイクルまで）＝ 原則 **マージ不可**
- **<sub><sub>![P2 Badge](https://img.shields.io/badge/P2-yellow?style=flat)</sub></sub>**: 通常。フォローアップ Issue/PR で可
- **<sub><sub>![P3 Badge](https://img.shields.io/badge/P3-green?style=flat)</sub></sub>**: 軽微。機会対応

### レビュー方針

- **可読性 vs 性能**: 非ホットパス／差が軽微 → **可読性優先**。ホットパスで有意差 → **性能優先**（計測・計算量等の根拠を併記）
- **スコープ最小**: 変更範囲外の大規模リファクタは **提案のみ**（自動書換しない）
- **一貫性**: 既存の命名・依存・フォーマットを尊重。**追加依存は最後の手段**
- **テスト**: 既存テスト前提。失敗時は **再現手順と原因推定** を記載
- **機密**: 資格情報や機密データは生成・出力しない

### 出力例（簡略）

- **総合判定**: 不可
- **指摘**:
  - **<sub><sub>![P1 Badge](https://img.shields.io/badge/P1-orange?style=flat)</sub></sub> 入力境界未チェック（負数許容）。例: `parse()` 前に `x < 0` を弾くべき**
  - **<sub><sub>![P3 Badge](https://img.shields.io/badge/P3-green?style=flat)</sub></sub> 命名の一貫性（`foo_id` → `fooId`）の提案**

**パッチ（抜粋）**:

```diff
- const id = parse(x)
+ if (x < 0) return err
+ const id = parse(x)
```
