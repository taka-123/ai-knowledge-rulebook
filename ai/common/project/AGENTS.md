## 0. 前提

- @README.md

### 技術スタック

- @technologystack.md

### ディレクトリ概要

- @directorystructure.md

## 1. 基本動作原則

- **指示理解**: ユーザー指示を精読し、範囲・制約・依存関係を確認する。不明点は即質問。
- **タスク分析**: 下記テンプレで目的から品質基準までを整理し、共有する。

```markdown
## タスク分析

- 目的: [最終目標]
- 技術要件: [利用技術・制約]
- 実装手順: [主要ステップ]
- リスク: [想定課題]
- 品質基準: [満たすべき指標]
```

- **プロセス選択**: タスク規模と影響から 🟢 / 🟡 / 🔴 を判定し、該当プロセスと報告テンプレを宣言する。
- **計画と実装**: 変更は最小単位で進め、既存スタイルと安全性を優先。進捗・判断をこまめに共有する。
- **確認要否の明示**: 承認や回答を待つときは応答の末尾に `【確認待ち】` セクションを置き、求めるアクションを 1 行で示す（例: `- 実装に進めてよいか確認をお願いします`）。ユーザーから明示的に `y/n` 指示がある場合はそれに従う。

## 2. タスク分類と実行プロセス

1. **🟢 軽量タスク**（簡略プロセス）
   - 例: 設定ファイルの確認、小規模スクリプトの修正、10 行以内の軽微修正。
   - 手順: 簡易分析（概要 1 行・リスク 1 点） → 実行ステップを 3〜5 項目で列挙 → 即実行。
   - 報告テンプレ:

```markdown
**実行中**: [⏳] 対象確認中...
**完了**: [✅] 結果: [1 行要約]
```

2. **🟡 標準タスク**（標準プロセス）

   - 例: 主要機能の改修、外部 API・データベース連携、文字コード・フォーマット調整。
   - 手順:
     1. タスク分析を共有。
     2. 実行計画（依存/独立/ブロッカーを明示した 5 項目以内のチェックリスト）。
     3. プロジェクトのチェックリスト（下記テンプレを基礎にカスタム）に沿って実装。
     4. 検証（テスト・レビュー）→ 標準報告テンプレで共有。
   - 進捗表示例: `**進行中**: [✅✅⏳⬜⬜] 2/5 完了 - 現在: Parser調整`。

3. **🔴 重要タスク**（拡張プロセス＋承認必須）
   - 例: インフラ設定・権限変更、通信仕様変更、大規模なデータモデル変更。
   - 手順: 詳細分析（影響・リスク・ロールバック・セキュリティ） → 承認取得 → 準備／実装／検証の段階実行 → 重要タスク報告テンプレで共有。
   - ブロッカータスクは ⛔ で明示し、解消まで他作業を停止。

### 並列実行ガイドライン

```markdown
🟢 独立タスク: 並列実行推奨
🟡 弱依存タスク: 条件付き並列（入力の確定を確認）
🔴 強依存タスク: 順次実行必須
⛔ ブロッカータスク: 解消まで停止
```

### ツール呼び出しポリシー

- 🟢 軽量タスク: 簡易分析を共有したら即ツール実行してよい。
- 🟡 標準タスク: 実行計画とチェックリストを提示し、合意後にツールを実行する。
- 🔴 重要タスク: 詳細分析と承認取得を完了してから段階的にツールを実行する。
- 長時間処理や外部依存の操作は背景実行や進捗共有を徹底し、ユーザーと同期する。

## 3. 実務フロー

- **初期分析**: 既存コード整合性、入力データ形式、セキュリティ・性能リスクを把握。
- **実装**: 既存の変換・エラーパターンを踏襲し、変更範囲を最小化。
- **検証**: 単体・統合・形式変換テストを実施し、結果を共有。
- **最終確認**: 要件、品質、ドキュメント、ロールバック手段を最終チェック。

### 実装チェックリスト

```markdown
1. [Input] エントリーポイントと受信データ確認
2. [Parser] レスポンス／ペイロードの解析と構造化
3. [Transform] 文字コード・形式変換
4. [Persistence] データベース／ストレージ更新
5. [Error] エラーハンドリング・ログ・リトライ
```

## 4. 品質・リスク管理

- **テスト適用範囲**
  - 🟢 軽量: 構文・基本動作チェック。
  - 🟡 標準: データ処理・連携機能・変換結果の確認。
  - 🔴 重要: 統合・負荷・エラー挙動・セキュリティ検証。
- **エラー分類と対応**

```markdown
🟢 軽度: 記録しつつ継続（例: 警告ログ、非推奨 API）
🟡 アプリケーション: 自動リトライ後に報告（例: 解析失敗、フォーマット不一致）
🔴 システム: 即停止・承認待ち（例: タイムアウト、通信断）
⛔ セキュリティ: 全作業停止・緊急報告（例: 認証情報漏洩）
```

### Linter／静的解析対応

- 🟢 自動修正可能な整形・import 順序は即時反映し、差分を共有する。
- 🟡 型エラーや未使用変数は修正案を整理してから適用（またはユーザー確認）する。
- 🔴 ロジックエラーや設計見直しを伴う警告は必ず状況を共有し、合意の上で対応する。
- **禁止事項**: `any` 型による回避、未解決警告の放置、暫定コメントアウトでの抑止。

- **運用チェックポイント**
  - 既存スタイル・依存関係を最優先。
  - 変更は小さく段階的に。ロールバック手段を維持。
  - `.env` 等の機密情報には触れず、必要時は利用者に依頼。
  - 追加依存は最小限。不要になった依存は削除を検討。
  - SQL はキーワード大文字・句単位改行で整形。
  - 実ファイルに作業用コメントは残さない。
- **禁止事項**: 不適切な文字コード処理、形式破壊、誤ったエラー処理、セキュリティリスクの放置、`any` 型使用による型安全性の毀損。

## 5. 報告とコンテキスト管理

- **軽量タスク報告**

```markdown
**完了**: [対象] [タスク名] - 結果: [1 行要約]
```

- **標準タスク報告**

```markdown
## 実行結果（対象機能）

**処理構成**: [主要コンポーネント]
**データ変換**: [形式・文字コード状況]
**外部連携**: [接続先・更新状況]
**注意点**: [既知の制約]
```

- **重要タスク報告**

```markdown
# 実行結果詳細

## 概要

[全体要約]

## 技術スタック影響

- Runtime / SDK: [影響]
- 主要ライブラリ: [影響]

## 実装詳細

1. Handler 層: [実装内容]
2. Parser 層: [実装内容]
3. Convert 層: [実装内容]
4. Database 層: [実装内容]

## 変換・レガシー対応

- CP932/Shift_JIS 処理: [確認結果]
- 文字化け対策: [確認結果]
- kfresponse データ形式対応: [確認結果]

## 今後の保守注意事項

- [変換処理上の注意]
- [外部システム変更時の影響]
```

- **進捗アップデート（任意）**

```markdown
**進行中**: [✅✅⏳⬜⬜] 2/5 完了 - 現在: [タスク名]
**更新**: [✅✅✅⏳⬜] 3/5 完了 - 新規: [着手内容]
```

- **長時間タスク管理（推奨）**

```markdown
## 30 分毎の進捗確認

- 完了項目: [リスト]
- 進行中: [現在の作業]
- 残り項目: [リスト]
- 予想残り時間: [X 分]
```

- **中断・再開サポート（必要時）**

```markdown
## 中断ポイント記録

**完了**: ステップ 1-3
**進行中**: ステップ 4（60% 完了 - [詳細]）
**未着手**: ステップ 5-7
**環境状態**: [ブランチ名] / 依存関係: [状況]
**再開手順**: `git checkout [branch] && npm install`
```

## 6. 承認が必要な変更

- ランタイム・主要ライブラリのバージョン変更。
- 外部システムとの通信仕様・プロトコル変更。
- データベース／ストレージのスキーマ変更。
- インフラ設定（権限・リソース・ネットワーク）変更。
- セキュリティ・認証方式の変更。

## 7. 今後の利用に向けたメモ

- 変更履歴を明確にし、承認プロセスを整備する。
- ランタイムや外部システムの仕様変更時は、必要な承認とドキュメント更新を行う。
