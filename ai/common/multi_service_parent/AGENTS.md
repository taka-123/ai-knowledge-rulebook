# マルチサービス統合プロジェクト ガイドライン

---

## 🚨 サービス別ルールの必須確認 🚨

### サービス固有 AGENTS.md の必須読み込み

**このプロジェクトはマルチサービス構成です。**

各サービスディレクトリには独自の `AGENTS.md` があり、**そのサービスのファイルを触る前に必ず読み込むこと。**

#### 📍 サービス別 AGENTS.md の配置ルール

**パターン**: `[サービスディレクトリパス]/AGENTS.md`

**例:**

- `services/service-a/` を触る → `services/service-a/AGENTS.md` を読む
- `apps/frontend/` を触る → `apps/frontend/AGENTS.md` を読む
- `backend/api/` を触る → `backend/api/AGENTS.md` を読む

**これ以外のサービスも、ルールは同様です。**

#### ⚙️ 実行手順

1. **ファイルパスを確認** → どのサービスディレクトリ配下か判定
2. **即座に該当ファイルを読み込む** → 例: `services/service-a/AGENTS.md`
3. **読み込み完了を確認** → その内容を最優先ルールとして適用
4. **作業開始**

#### ⚠️ 絶対禁止事項

- サービス固有 `AGENTS.md` を読まずに作業開始すること
- 「簡単な作業だから不要」と判断すること
- 読み込みを後回しにすること

#### 🔄 優先順位

1. **サービス固有 `AGENTS.md`** （最優先）
2. プロジェクトルート `AGENTS.md`（このファイル）
3. グローバルルール

競合時は上記の順で優先。

---

## 0. 前提

- @README.md

### 技術スタック

- @technologystack.md

### ディレクトリ概要

- @directorystructure.md

## 1. 基本動作原則

- **指示理解**: ユーザー指示を精読し、範囲・制約・依存関係を確認する。不明点は即質問。
- **タスク分析**: 下記テンプレで目的から品質基準までを整理し、共有する。

```markdown
## タスク分析

- 目的: [最終目標]
- 技術要件: [利用技術・制約]
- 実装手順: [主要ステップ]
- リスク: [想定課題]
- 品質基準: [満たすべき指標]
```

- **プロセス選択**: タスク規模と影響から 🟢 / 🟡 / 🔴 を判定し、該当プロセスと報告テンプレを宣言する。
- **計画と実装**: 変更は最小単位で進め、既存スタイルと安全性を優先。進捗・判断をこまめに共有する。
- **確認要否の明示**: 承認や回答を待つときは応答の末尾に `【確認待ち】` セクションを置き、求めるアクションを 1 行で示す（例: `- 実装に進めてよいか確認をお願いします(y/n)`）。ユーザーから明示的に指示がある場合はそれに従う。

## 2. 実務フロー

- **初期分析**: 既存コード整合性、入力データ形式、セキュリティ・性能リスクを把握
- **実装**: 既存の変換・エラーパターンを踏襲し、変更範囲を最小化
- **検証**: 単体・統合・形式変換テストを実施し、結果を共有
- **最終確認**: 要件、品質、ドキュメント、ロールバック手段を最終チェック

### 実装チェックリスト

```markdown
1. [Input] エントリーポイントと受信データ確認
2. [Parser] レスポンス／ペイロードの解析と構造化
3. [Transform] 文字コード・形式変換（必要に応じて）
4. [Persistence] データベース／ストレージ更新
5. [Error] エラーハンドリング・ログ・リトライ
6. [Test] 単体テスト・統合テストの実施
```

## 3. 品質・リスク管理

### テスト適用範囲

- 🟢 軽量: 構文・基本動作チェック
- 🟡 標準: データ処理・連携機能・変換結果の確認
- 🔴 重要: 統合・負荷・エラー挙動・セキュリティ検証

### 運用チェックポイント

- 既存スタイル・依存関係を最優先
- 変更は小さく段階的に。ロールバック手段を維持
- `.env` 等の機密情報には触れず、必要時は利用者に依頼
- 追加依存は最小限。不要になった依存は削除を検討
- 実ファイルに作業用コメントは残さない

### 禁止事項（プロジェクト共通）

- 不適切な文字コード変換処理（例: エンコーディング不整合）
- データ形式破壊（例: レガシーフォーマットの誤変換）
- 業務データ損失を招くエラー処理の不備
- サービス固有 `AGENTS.md` を読まずに作業開始すること

## 4. 報告とコンテキスト管理

### 軽量タスク報告

```markdown
**完了**: [対象] [タスク名] - 結果: [1 行要約]
```

### 標準タスク報告

```markdown
## 実行結果（対象機能）

**処理構成**: [主要コンポーネント]
**データ変換**: [形式・文字コード状況]
**外部連携**: [接続先・更新状況]
**注意点**: [既知の制約]
```

### 重要タスク報告

```markdown
# 実行結果詳細

## 概要

[全体要約]

## 技術スタック影響

- Runtime / SDK: [影響]
- 主要ライブラリ: [影響]
- データベース: [影響]
- キャッシュ: [影響]

## 実装詳細

1. Handler 層: [実装内容]
2. Parser 層: [実装内容]
3. Convert 層: [実装内容]
4. Database 層: [実装内容]

## マイクロサービス連携（該当する場合）

- サービス間API連携: [確認結果]
- 共通ライブラリ使用: [確認結果]
- データベーススキーマ変更: [確認結果]

## 今後の保守注意事項

- [変換処理上の注意]
- [外部システム変更時の影響]
- [サービス間依存関係の注意]
```

## 5. 承認が必要な変更

- ランタイムバージョン変更
- 主要フレームワーク・ライブラリのメジャーバージョンアップグレード
- データベーススキーマの大幅な変更
- サービス間API通信仕様・プロトコルの変更
- セキュリティ設定の変更（CORS, XSS対策, 認証・認可等）
- 環境設定ファイル（`.env`等）の変更
- コンテナ設定の大幅な変更（`docker-compose.yml`, Dockerfile等）

## 6. 今後の利用に向けたメモ

- 変更履歴を明確にし、承認プロセスを整備する
- ランタイムや外部システムの仕様変更時は、必要な承認とドキュメント更新を行う
- マイクロサービス構成のため、各サービスの技術スタック・依存関係を常に把握する
- サービス固有の詳細な開発ルールは各サービスディレクトリの `AGENTS.md` を参照する
